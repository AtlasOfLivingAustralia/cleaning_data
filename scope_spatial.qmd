---
output: html_document
editor_options: 
  chunk_output_type: console
---

# Spatial scope

It's useful to investigate the spatial range of available data for your
taxonomic group(s) of interest. How specific your question can be may change
depending on whether the majority of data is in only a few locations or evenly
spread over the entire distribution of a species or taxonomic group.

For our example question about *Lampromicra*, we may wish to map where
observations in Australia have been made. We can do this by using the {ozmaps}
package to download a nice map of Australia, plot it with `sf::geom_sf()`, and
add our observation points on top with `geom_point()`. We can separate the
colours of our points by setting `colour = scientificName` within the `aes()` of
`geom_point()`.

:::{.callout-note} 

You will need to add an email address [registered with the
Atlas of Living
Australia](https://auth.ala.org.au/userdetails/registration/createAccount) in
`galah_config()` to download species information. 

:::

```{r} 
#| code-fold: true
#| code-summary: "Load required packages"
#| message: false
library(galah)
library(tidyr)
library(sf)
library(ggplot2)
library(paletteer) # colour palettes
library(ozmaps)
library(viridis)
library(gt)
library(here)
library(rmapshaper)
```

```{r}
#| eval: false
galah_config(email = "youremail@here.com")
```

```{r}
#| include: false
galah_config(verbose = FALSE)
galah_config(email = "oliviajane.t@hotmail.com")
```

```{r}
beetles <- galah_call() |>
  galah_identify("lampromicra") |>
  atlas_occurrences() |>
  tidyr::drop_na() # remove any NA values

# Get map of australia, and transform to WGS84
aus <- st_transform(ozmaps::ozmap_country, 4326)

# Plot the observations on our map of Australia
ggplot() +
  geom_sf(data = aus, colour = "grey60", fill = "white", alpha = 0.2) +
  geom_point(
    data = beetles,
    mapping = aes(
      x = decimalLongitude, y = decimalLatitude, colour =
        scientificName
    ),
    size = 1.8, alpha = 0.6
  ) +
  scale_color_paletteer_d("feathers::eastern_rosella") +
  coord_sf(xlim = c(110, 155), ylim = c(-45, -10)) +
  theme_void()
```


Plotting our points shows us that observations are spread along the northern and
eastern coasts of Australia. We can also see that some observations are only
identified to the genus level (e.g. *Lampromicra*), rather than to a specific
species (e.g. *Lampromicra aerea*).

There are several places on the east coast of Australia where there are clumps
of overlapping points. It's difficult to tell how many observations there really
are in those areas. To investigate, we can recreate this into a point density
plot using the [{ggpointdensity
package}](https://github.com/LKremer/ggpointdensity). 

```{r} 
#| code-fold: true
library(ggpointdensity)

ggplot() +
  geom_sf(data = aus, colour = "grey60", fill = "white", alpha = 0.2) +
  geom_pointdensity(
    data = beetles,
    mapping = aes(x = decimalLongitude, y = decimalLatitude)
  ) +
  scale_color_paletteer_c("viridis::plasma") +
  coord_sf(xlim = c(110, 155), ylim = c(-45, -10)) +
  theme_void()
```

Adding the density of overlapping points to our map allows us to see that there
is one area with many more observationsâ€”more than 400 observations are found in
the light yellow area!

Using this information, we might decide to make our research question more
specific to the region where there are the most records of *Lampromicra*.

Let's have a look at these records in the context of their IBRA bioregions
(distinct areas defined on a common climate, geology, landform, native
vegetation and species information). 

To find out what region(s) the genus *Lampromicra* is  most common, you can
`group_by` the IBRA region field code in {galah} (use `search_fields` to see
others).


```{r} 
ibra_counts <- galah_call() |>
  galah_identify("Lampromicra") |>
  galah_group_by("cl1048") |> # IBRA regions
  atlas_counts()
gt(head(ibra_counts))
```

<aside> 

**South Eastern Queensland** (red), **Sydney Basin** (green)

```{r} 
#| echo: false
#| message: false
#| warning: false

shapefile <- st_read(
  here(
    "data",
    "shapefiles",
    "IBRA7_regions",
    "ibra7_regions.shp"
  ),
  quiet = TRUE
) |>
  ms_simplify(keep = 0.1)

# IBRA Regions
ggplot() +
  geom_sf(
    data = shapefile %>% filter(REG_NAME_7 == "South Eastern Queensland"),
    aes(fill = "red"),
    colour = "black",
    alpha = 0.7
  ) +
  geom_sf(
    data = shapefile %>% filter(REG_NAME_7 == "Sydney Basin"),
    aes(fill = "green"),
    colour = "black",
    alpha = 0.2
  ) +
  geom_sf(
    data = shapefile %>% filter(REG_NAME_7 != c("South Eastern Queensland", "Sydney Basin")),
    aes(fill = "white"),
    colour = "grey60",
    alpha = 0.2
  ) +
  geom_point(
    data = beetles,
    mapping = aes(
      x = decimalLongitude,
      y = decimalLatitude
    ),
    size = 0.05
  ) +
  coord_sf(
    xlim = c(110, 155),
    ylim = c(-45, -10)
  ) +
  scale_fill_identity() +
  theme_void()
```

</aside> 

Looks like South East Queensland has the most records followed by Sydney
Basin. 

This could be due to sampling bias in that Brisbane and Sydney are large
metropolitan areas. You might choose to investigate [this bias
further](https://labs.ala.org.au/posts/2022-07-22_sample-bias/post.html). 

```{r}
#| code-fold: true
#| column: page
#| fig-align: center
#| layout-nrow: 1
#| message: false
#| warning: false

shapefile <- st_read(
  here(
    "data",
    "shapefiles",
    "IBRA7_regions",
    "ibra7_regions.shp"
  ),
  quiet = TRUE
) |>
  ms_simplify(keep = 0.1)


# South Eastern Queensland
ggplot() +
  geom_sf(
    data = shapefile %>% filter(REG_NAME_7 == "South Eastern Queensland"),
    aes(fill = "red"),
    colour = "grey60",
    alpha = 0.7
  ) +
  geom_sf(
    data = shapefile %>% filter(REG_NAME_7 != "South Eastern Queensland"),
    aes(fill = "white"),
    colour = "grey60",
    alpha = 0.2
  ) +
  geom_point(
    data = beetles,
    mapping = aes(
      x = decimalLongitude,
      y = decimalLatitude
    ),
    size = 0.5
  ) +
  coord_sf(
    xlim = c(140, 155),
    ylim = c(-30, -10)
  ) +
  scale_fill_identity() +
  theme_void()

# Sydney Basin
ggplot() +
  geom_sf(
    data = aus,
    colour = "grey60",
    fill = "white",
    alpha = 0.2
  ) +
  geom_sf(
    data = shapefile %>% filter(REG_NAME_7 == "Sydney Basin"),
    aes(fill = "green"),
    colour = "grey60",
    alpha = 0.7
  ) +
  geom_sf(
    data = shapefile %>% filter(REG_NAME_7 != "Sydney Basin"),
    aes(fill = "white"),
    colour = "grey60",
    alpha = 0.2
  ) +
  geom_point(
    data = beetles,
    mapping = aes(
      x = decimalLongitude,
      y = decimalLatitude
    ),
    size = 0.5
  ) +
  coord_sf(
    xlim = c(145, 155),
    ylim = c(-37, -30)
  ) +
  scale_fill_identity() +
  theme_void()
```


Alternatively, we might decide that there isn't enough data (or data of a good
enough quality) to make accurate estimates about *Lampromicra*. 

Depending on the spatial specificity of your question, you might have to adjust
your data scope or your question accordingly.
